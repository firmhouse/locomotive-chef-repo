
<%= @custom_configuration["before_server"] %>

<% if @redirect_domain_names && @redirect_domain_names.any? %>
server {
  listen <%= node['nginx']['port'] || '80' %>;
  server_name <%= @redirect_domain_names.join(' ') %>;
  return 301 $scheme://<%= @domain_names.first %>$request_uri;
}
<% end %>

<% if @redirect_domain_names && @redirect_domain_names.any? && @enable_ssl %>
server {
  listen 443 ssl;
  server_name <%= @redirect_domain_names.join(' ') %>;
  ssl_certificate <%= node['rails']['applications_root'] %>/<%= @name %>/shared/config/certificate.crt;
  ssl_certificate_key <%= node['rails']['applications_root'] %>/<%= @name %>/shared/config/certificate.key;
  return 301 $scheme://<%= @domain_names.first %>$request_uri;
}
<% end %>

server {
  listen <%= node['nginx']['port'] || '80' %>;
  server_name <%= @domain_names.join(' ') %>;
  root <%= @server_root_public_path %>;

  passenger_enabled on;
  passenger_app_env <%= @rails_env %>;

  <%= render '_app_nginx_location_assets.erb', variables: { server_root_public_path: @server_root_public_path } if @gzip_enabled %>

  <%= @custom_configuration["server_main"] %>
}

<% if @enable_ssl %>

server {
  listen 443 ssl;

  ssl_certificate <%= node['rails']['applications_root'] %>/<%= @name %>/shared/config/certificate.crt;
  ssl_certificate_key <%= node['rails']['applications_root'] %>/<%= @name %>/shared/config/certificate.key;

  passenger_enabled on;
  passenger_app_env <%= @rails_env %>;

  server_name <%= @domain_names.join(' ') %>;

  root <%= @server_root_public_path %>; 

  <%= render '_app_nginx_location_assets.erb', variables: { server_root_public_path: @server_root_public_path } if @gzip_enabled %>

  <%= @custom_configuration["ssl_main"] %>
}

<% end %>

<%= @custom_configuration["after_server"] %>
